<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rohit's Tech Blog | Latest in Blockchain & AI</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Canvas Widget Overlay Styles */
        .canvas-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .canvas-overlay.active {
            display: flex;
        }

        .canvas-overlay-content {
            position: relative;
            max-width: 100%;
            max-height: 100%;
        }

        .canvas-iframe-wrapper {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 450px;
            height: 750px;
            max-width: 100vw;
            max-height: 95vh;
        }

        .canvas-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* Blur content when overlay is active */
        body.verification-required .page-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        @media (max-width: 768px) {
            .canvas-iframe-wrapper {
                border-radius: 0;
                width: 100vw;
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <!-- Canvas Widget Overlay -->
    <div class="canvas-overlay" id="canvasOverlay">
        <div class="canvas-overlay-content">
            <div class="canvas-iframe-wrapper">
                <iframe 
                    src="" 
                    class="canvas-iframe"
                    id="canvasWidget"
                    allow="clipboard-write"
                ></iframe>
            </div>
        </div>
    </div>

    <!-- Main Page Content -->
    <div class="page-content">
        <!-- Navigation -->
        <header class="header">
            <div class="nav-container">
                <div class="logo">Rohit's Blog</div>
                <nav class="nav-links">
                    <a href="index.html" class="active">Home</a>
                    <a href="article-bitcoin.html">Bitcoin ATH</a>
                    <a href="article-ai.html">AI Trends</a>
                    <a href="article-defi.html">DeFi 2025</a>
                    <a href="about.html">About</a>
                </nav>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h1>Insights on Blockchain, AI, and the Future of Tech</h1>
                <p>Welcome! Exploring the intersection of technology, finance, and innovation.</p>
            </div>
        </section>

        <!-- Article Grid -->
        <main class="container">
            <div class="articles-grid">
                <!-- Featured Article -->
                <article class="article-card featured">
                    <div class="article-image bitcoin-bg">‚Çø</div>
                    <div class="article-content">
                        <span class="category">BLOCKCHAIN</span>
                        <h2><a href="article-bitcoin.html">Bitcoin Hits New All-Time High as Institutional Adoption Accelerates</a></h2>
                        <p>In a historic moment for cryptocurrency markets, Bitcoin surged past $100,000 today, marking a new all-time high...</p>
                        <div class="article-meta">
                            <span>Rohit Sarkar</span>
                            <span>‚Ä¢</span>
                            <span>Nov 10, 2025</span>
                            <span>‚Ä¢</span>
                            <span>5 min read</span>
                        </div>
                    </div>
                </article>

                <!-- Regular Articles -->
                <article class="article-card">
                    <div class="article-image ai-bg">ü§ñ</div>
                    <div class="article-content">
                        <span class="category">ARTIFICIAL INTELLIGENCE</span>
                        <h2><a href="article-ai.html">AI Agents Are Reshaping the Enterprise Software Landscape</a></h2>
                        <p>Large language models have evolved from chatbots to autonomous agents capable of complex workflows...</p>
                        <div class="article-meta">
                            <span>Rohit Sarkar</span>
                            <span>‚Ä¢</span>
                            <span>Nov 8, 2025</span>
                            <span>‚Ä¢</span>
                            <span>4 min read</span>
                        </div>
                    </div>
                </article>

                <article class="article-card">
                    <div class="article-image defi-bg">üí∞</div>
                    <div class="article-content">
                        <span class="category">DEFI</span>
                        <h2><a href="article-defi.html">The State of DeFi in 2025: What's Working and What's Not</a></h2>
                        <p>Decentralized finance has matured significantly, but challenges around UX and regulation remain...</p>
                        <div class="article-meta">
                            <span>Rohit Sarkar</span>
                            <span>‚Ä¢</span>
                            <span>Nov 5, 2025</span>
                            <span>‚Ä¢</span>
                            <span>6 min read</span>
                        </div>
                    </div>
                </article>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>&copy; 2025 Rohit's Blog. All rights reserved.</p>
                <p>Powered by Canvas Protocol for human verification</p>
            </div>
        </footer>
    </div>

    <script>
        // ==========================================
        // Canvas Protocol Configuration
        // ==========================================
        
        const API_BASE_URL = 'https://canvas-api.duckdns.org'; // Live API endpoint
        
        // Verification token management
        const VERIFICATION_TOKEN = 'canvas_verified';
        const TOKEN_EXPIRY = 'canvas_verified_expiry';
        const TOKEN_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        // ==========================================
        // Helper Functions
        // ==========================================
        
        /**
         * Get the current domain from the URL
         * For local files, this might be 'localhost' or the actual domain when deployed
         */
        function getCurrentDomain() {
            const hostname = window.location.hostname;
            
            // Handle localhost and file:// protocol
            if (hostname === '' || hostname === 'localhost' || hostname === '127.0.0.1') {
                // For demo purposes, return a demo domain
                // In production, this would be your actual domain
                return 'techblog.example.com';
            }
            
            // Remove 'www.' if present
            return hostname.replace(/^www\./, '');
        }

        /**
         * Check if user has valid verification token
         * For demo purposes, always return false to show CAPTCHA
         */
        function checkVerification() {
            // Always return false for demo to show CAPTCHA every time
            console.log('[Canvas] üé¨ Demo mode: Always require verification');
            return false;
        }

        /**
         * Store verification token after successful CAPTCHA
         */
        function storeVerificationToken() {
            const now = Date.now();
            const expiry = now + TOKEN_DURATION;
            
            localStorage.setItem(VERIFICATION_TOKEN, 'true');
            localStorage.setItem(TOKEN_EXPIRY, expiry.toString());
            
            console.log('[Canvas] ‚úÖ Verification token stored, valid for 24 hours');
        }

        /**
         * Show verification overlay with CAPTCHA
         */
        function showVerificationOverlay() {
            console.log('[Canvas] üé® Showing verification overlay');
            document.body.classList.add('verification-required');
            document.getElementById('canvasOverlay').classList.add('active');
        }

        /**
         * Hide verification overlay
         */
        function hideVerificationOverlay() {
            console.log('[Canvas] ‚úÖ Hiding verification overlay');
            document.body.classList.remove('verification-required');
            document.getElementById('canvasOverlay').classList.remove('active');
        }

        // ==========================================
        // Publisher & Campaign Validation
        // ==========================================

        /**
         * Find publisher by matching domain to website_url
         */
        async function fetchPublisherByDomain() {
            try {
                const domain = getCurrentDomain();
                console.log('[Canvas] üîç Checking for publisher registration:', domain);
                
                // Fetch all publishers
                const response = await fetch(`${API_BASE_URL}/publishers`);
                
                if (!response.ok) {
                    console.log('[Canvas] ‚ö†Ô∏è Unable to reach Canvas Protocol API');
                    return null;
                }
                
                const data = await response.json();
                
                if (!data.success || !data.publishers || data.publishers.length === 0) {
                    console.log('[Canvas] ‚ö†Ô∏è No publishers registered in system');
                    return null;
                }
                
                // Find publisher matching this domain
                const publisher = data.publishers.find(p => {
                    if (!p.website_url) return false;
                    
                    try {
                        const publisherUrl = new URL(p.website_url);
                        const publisherDomain = publisherUrl.hostname.replace(/^www\./, '');
                        return publisherDomain === domain;
                    } catch (e) {
                        // Invalid URL format
                        return false;
                    }
                });
                
                if (!publisher) {
                    console.log('[Canvas] ‚ùå No publisher registered for domain:', domain);
                    console.log('[Canvas] ‚ÑπÔ∏è  To monetize this site:');
                    console.log('[Canvas]     1. Go to publisher-signup.html');
                    console.log('[Canvas]     2. Enter website URL that matches this domain');
                    console.log('[Canvas]     3. Complete signup');
                    return null;
                }
                
                console.log('[Canvas] ‚úÖ Publisher found:', publisher.name);
                console.log('[Canvas]    Address:', publisher.ethereum_address);
                console.log('[Canvas]    Total earnings:', publisher.total_earnings_wei, 'wei');
                
                return publisher;
                
            } catch (error) {
                console.log('[Canvas] ‚ùå Error checking publisher:', error.message);
                return null;
            }
        }

        /**
         * Check for active campaigns with available budget
         */
        async function fetchActiveCampaigns() {
            try {
                console.log('[Canvas] üîç Checking for active campaigns...');
                
                const response = await fetch(`${API_BASE_URL}/campaigns`);
                
                if (!response.ok) {
                    console.log('[Canvas] ‚ö†Ô∏è Unable to fetch campaigns');
                    return [];
                }
                
                const data = await response.json();
                
                if (!data.success || !data.campaigns || data.campaigns.length === 0) {
                    console.log('[Canvas] ‚ö†Ô∏è No campaigns available');
                    return [];
                }
                
                // Filter for active campaigns with budget remaining
                const activeCampaigns = data.campaigns.filter(campaign => {
                    if (campaign.status !== 'active') {
                        return false;
                    }
                    
                    // Check if campaign has budget remaining
                    const totalBudget = parseFloat(campaign.total_budget_wei);
                    const spentBudget = parseFloat(campaign.spent_budget_wei);
                    const costPerCaptcha = parseFloat(campaign.cost_per_captcha_wei);
                    const remainingBudget = totalBudget - spentBudget;
                    
                    if (remainingBudget < costPerCaptcha) {
                        console.log('[Canvas] ‚ö†Ô∏è Campaign has insufficient budget:', campaign.name);
                        return false;
                    }
                    
                    return true;
                });
                
                if (activeCampaigns.length === 0) {
                    console.log('[Canvas] ‚ö†Ô∏è No campaigns with available budget');
                    return [];
                }
                
                console.log('[Canvas] ‚úÖ Found', activeCampaigns.length, 'active campaigns with budget');
                activeCampaigns.forEach(c => {
                    const remaining = parseFloat(c.total_budget_wei) - parseFloat(c.spent_budget_wei);
                    console.log('[Canvas]    -', c.name, '| Budget remaining:', remaining, 'wei');
                });
                
                return activeCampaigns;
                
            } catch (error) {
                console.log('[Canvas] ‚ùå Error fetching campaigns:', error.message);
                return [];
            }
        }

        // ==========================================
        // Canvas Widget Initialization
        // ==========================================

        async function initializeCanvasWidget() {
            console.log('[Canvas] üöÄ Starting Canvas Protocol...');
            console.log('[Canvas] üìç Domain:', getCurrentDomain());
            
            // Demo mode: Skip verification check and always proceed to CAPTCHA
            console.log('[Canvas] üé¨ Demo mode: Skipping verification check');
            
            // Step 1: Find publisher for this domain
            const publisher = await fetchPublisherByDomain();
            
            if (!publisher) {
                console.log('[Canvas] ‚ÑπÔ∏è  This website is not registered with Canvas Protocol');
                console.log('[Canvas] ‚ÑπÔ∏è  Users can browse freely without verification');
                return;
            }
            
            // Step 2: Check for active campaigns with budget
            const campaigns = await fetchActiveCampaigns();
            
            if (campaigns.length === 0) {
                console.log('[Canvas] ‚ÑπÔ∏è  No active campaigns with budget available');
                console.log('[Canvas] ‚ÑπÔ∏è  Users can browse freely without verification');
                console.log('[Canvas] üí° Advertisers: Create a campaign to start monetizing!');
                return;
            }
            
            // Step 3: All checks passed - show CAPTCHA widget
            const selectedCampaign = campaigns[0]; // Use first available campaign
            
            console.log('[Canvas] ‚úÖ All checks passed!');
            console.log('[Canvas]    Publisher:', publisher.name);
            console.log('[Canvas]    Campaign:', selectedCampaign.name);
            console.log('[Canvas]    Cost per CAPTCHA:', selectedCampaign.cost_per_captcha_wei, 'wei');
            console.log('[Canvas] üé® Loading Canvas widget...');
            
            // Load widget with publisher and campaign info
            const iframe = document.getElementById('canvasWidget');
            iframe.src = `canvas-widget.html?publisherAddress=${publisher.ethereum_address}&campaignId=${selectedCampaign.id}`;
            
            // Show overlay
            showVerificationOverlay();
        }

        // ==========================================
        // Message Handling from Widget
        // ==========================================

        /**
         * Listen for CAPTCHA completion message from widget
         */
        window.addEventListener('message', function(event) {
            if (event.data.type === 'CAPTCHA_COMPLETE') {
                console.log('[Canvas] üéâ CAPTCHA completed successfully!');
                console.log('[Canvas]    Captcha ID:', event.data.captchaId);
                console.log('[Canvas]    Completion time:', event.data.completionTime, 'seconds');
                console.log('[Canvas]    Publisher earned:', event.data.paymentWei, 'wei');
                
                // Store verification token
                storeVerificationToken();
                
                // Hide overlay
                hideVerificationOverlay();
                
                console.log('[Canvas] ‚úÖ User can now browse the site freely for 24 hours');
            }
        });

        // ==========================================
        // Initialize on Page Load
        // ==========================================

        window.addEventListener('DOMContentLoaded', function() {
            initializeCanvasWidget();
        });

        // Prevent closing overlay by clicking outside
        document.getElementById('canvasOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                console.log('[Canvas] ‚ÑπÔ∏è  Please complete verification to continue');
            }
        });
    </script>
</body>
</html>
